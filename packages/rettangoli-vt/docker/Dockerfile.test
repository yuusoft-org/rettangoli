# Test Dockerfile - builds from local source for E2E testing
# Build context should be the monorepo root

FROM mcr.microsoft.com/playwright:v1.57.0-noble

# Install dependencies for Bun
RUN apt-get update && apt-get install -y unzip curl && rm -rf /var/lib/apt/lists/*

# Install Bun to system location
RUN curl -fsSL https://bun.sh/install | BUN_INSTALL=/usr/local bash

# Set working directory
WORKDIR /build

# Copy the CLI package which depends on VT
COPY packages/rettangoli-cli/package.json packages/rettangoli-cli/
COPY packages/rettangoli-cli/cli.js packages/rettangoli-cli/

# Copy the VT package (dependency of CLI)
COPY packages/rettangoli-vt/package.json packages/rettangoli-vt/
COPY packages/rettangoli-vt/src packages/rettangoli-vt/src

# Copy other required workspace packages
COPY packages/rettangoli-fe/package.json packages/rettangoli-fe/
COPY packages/rettangoli-fe/src packages/rettangoli-fe/src

COPY packages/rettangoli-ui/package.json packages/rettangoli-ui/
COPY packages/rettangoli-ui/src packages/rettangoli-ui/src

COPY packages/rettangoli-sites/package.json packages/rettangoli-sites/
COPY packages/rettangoli-sites/src packages/rettangoli-sites/src

# Copy the workspace lockfile and root package.json for workspace resolution
COPY bun.lock* ./
COPY package.json ./

# Install workspace dependencies from local source
RUN bun install

# Create a global symlink for the rtgl CLI
RUN ln -s /build/packages/rettangoli-cli/cli.js /usr/local/bin/rtgl && \
    chmod +x /build/packages/rettangoli-cli/cli.js

# Verify installation
RUN rtgl --version

# Set working directory to /workspace for mounted projects
WORKDIR /workspace
